#!/bin/sh
if [ -e /usr/share/enigma2/BlackHarmony/skin_user_bar ];then
  cp -f /usr/share/enigma2/BlackHarmony/skin_user_bar/* /usr/share/enigma2/BlackHarmony/menu/ 2>/dev/null
fi

if [ ! -e /usr/lib/enigma2/python/Plugins/Extensions/WeatherPlugin ]; then
  if `grep -q 'osd.language=pl_PL' </etc/enigma2/settings`; then
    echo
    echo "UWAGA:"
    echo "Aby działało w skórce wyświetlanie pogody, musisz doinstalować wtyczkę z pogodą MSN"
  else
    echo
    echo "ATTENTION:"
    echo "You need to install eMSN weather plugin plugin to use weather components in skin"
  fi
fi

if [ -e /usr/lib/enigma2/python/skin.py ];then #patching BlackHole skin.py to be less resstrictive, similar rules to openATV
  sed -i 's/\(^[ \t]*\)raise SkinError\(.*pixmap file %s not found!.*\)/\1print\2/' /usr/lib/enigma2/python/skin.py
  sed -i 's/\(^[ \t]*\)raise SkinError\(.*need color and name, got %s %s.*\)/\1print\2/' /usr/lib/enigma2/python/skin.py
  sed -i 's/\(^[ \t]*\)raise SkinError\(.*component with name .* was not found in skin of screen.*\)/\1print\2/' /usr/lib/enigma2/python/skin.py
  sed -i 's/\(^[ \t]*\)raise SkinError\(.*specified related screen .* was not found in screen.*\)/\1print\2/' /usr/lib/enigma2/python/skin.py
  sed -i 's/\(^[ \t]*\)raise SkinError\(.*source .* was not found in screen.*\)/\1print\2/' /usr/lib/enigma2/python/skin.py
  sed -i 's/\(^[ \t]*\)raise SkinError\(.*you must define a renderer with render= for source.*\)/\1print\2/' /usr/lib/enigma2/python/skin.py
  sed -i 's/\(^[ \t]*\)raise SkinError\(.*applet type .* unknown!.*\)/\1print\2/' /usr/lib/enigma2/python/skin.py
  echo
  echo '/usr/lib/enigma2/python/skin.py patched'
fi

#build skin.xml
echo '<skin>' > /usr/share/enigma2/BlackHarmony/skin.xml
cat /usr/share/enigma2/BlackHarmony/skin-header.xml >> /usr/share/enigma2/BlackHarmony/skin.xml
cat /usr/share/enigma2/BlackHarmony/screens-common.xml >> /usr/share/enigma2/BlackHarmony/skin.xml
if [ -e /usr/lib/enigma2/python/Plugins/SystemPlugins/VTIPanel ];then
  cat /usr/share/enigma2/BlackHarmony/screens-VTI_specific.xml >> /usr/share/enigma2/BlackHarmony/skin.xml
  echo 'VTI image'
elif [ -e /usr/lib/enigma2/python/Plugins/Extensions/Infopanel ];then
  cat /usr/share/enigma2/BlackHarmony/screens-openATV_specific.xml >> /usr/share/enigma2/BlackHarmony/skin.xml
  echo 'openATV image'
elif [ -e /usr/lib/enigma2/python/Blackhole ];then
  cat /usr/share/enigma2/BlackHarmony/screens-BlackHole_specific.xml >> /usr/share/enigma2/BlackHarmony/skin.xml
  sed -i 's/if compat == "passed"/if compat == compat/g' /usr/lib/enigma2/python/Plugins/SystemPlugins/SkinSelector/plugin.py
  echo 'VTI BlackHole image'
elif [ -e //etc/init.d/start_pkt.sh ];then
  cat /usr/share/enigma2/BlackHarmony/screens-PKT_specific.xml >> /usr/share/enigma2/BlackHarmony/skin.xml
  echo 'PKT image'
else
  cat /usr/share/enigma2/BlackHarmony/screens-unknown.xml >> /usr/share/enigma2/BlackHarmony/skin.xml
  echo 'UNKNOWN image'
fi
echo '</skin>' >> /usr/share/enigma2/BlackHarmony/skin.xml
sync
#
[ -e /usr/share/enigma2/BlackHarmony/mySkin/skin_user_BlackHarmony.xml ] && rm -f /usr/share/enigma2/BlackHarmony/mySkin/skin_user_BlackHarmony.xml
if [ -e /etc/enigma2/skin_user_BlackHarmony.xml ];then
  rm -f /etc/enigma2/skin_user_BlackHarmony.xml
  etcSkin=1
else
  etcSkin=0
fi
#prepare some links
find /usr/share/enigma2/BlackHarmony/allScreens -iname skin_channelselection_*.xml|while read f; do
  #echo "$f"
  if [ `echo "$f"|grep -c '/ChannelSelections/'` -eq 0 ]; then
    f2="`echo \"$f\"|sed 's;\(^.*/allScreens/\).*\(/skin_*\);\1ChannelSelections\2;'`"
    #echo "$f2"
    ln -sf "$f" "$f2"
  fi
done
find /usr/share/enigma2/BlackHarmony/allScreens -iname skin_infobar_*.xml|while read f; do
  #echo "$f"
  if [ `echo "$f"|grep -c '/Infobars/'` -eq 0 ]; then
    f2="`echo \"$f\"|sed 's;\(^.*/allScreens/\).*\(/skin_*\);\1Infobars\2;'`"
    #echo "$f2"
    ln -sf "$f" "$f2"
  fi
done
find /usr/share/enigma2/BlackHarmony/allScreens -iname skin_secondinfobar_*.xml|while read f; do
  #echo "$f"
  if [ `echo "$f"|grep -c '/Secondinfobars/'` -eq 0 ]; then
    f2="`echo \"$f\"|sed 's;\(^.*/allScreens/\).*\(/skin_*\);\1Secondinfobars\2;'`"
    #echo "$f2"
    ln -sf "$f" "$f2"
  fi
done
sync
find /usr/share/enigma2/BlackHarmony/allScreens -iname skin_volume_*.xml|while read f; do
  #echo "$f"
  if [ `echo "$f"|grep -c '/Volume/'` -eq 0 ]; then
    f2="`echo \"$f\"|sed 's;\(^.*/allScreens/\).*\(/skin_*\);\1Volume\2;'`"
    #echo "$f2"
    ln -sf "$f" "$f2"
  fi
done
sync
#bing image if not exists
[ -e /usr/share/enigma2/BlackHarmony/icons/BingPicOfTheDay.jpg ] || /usr/lib/enigma2/python/Components/j00zekBING.py
#final message
if [ -e /usr/share/enigma2/BlackHarmony/UserSkin_Selections/ ];then
  if `ls /usr/share/enigma2/BlackHarmony/UserSkin_Selections/ |grep -q '.xml'`;then
    cd /usr/share/enigma2/BlackHarmony/UserSkin_Selections
    #find -L . -name . -o -type d -prune -o -type l -exec rm {} +
    # jesli tryb laczenia to uzytkownik musi wejsc do userskin
    if [ `grep -c 'config.plugins.UserSkin.AdvancedMode=mergeScreens' </etc/enigma2/settings` -eq 1 ] ;then
      if `grep -q 'osd.language=pl_PL' </etc/enigma2/settings`; then
        echo
        echo "Nie zapomnij wejść do wtyczki UserSkin i wygenerować ponownie skórkę użytkownika"
      else
        echo
        echo "Do not forget to enter UserSkin plugin and recreate user skin"
      fi
    else # tryb kopiowania, możemy zregenerowac plik user_skin
      cd /usr/share/enigma2/BlackHarmony/UserSkin_Selections
      echo '<skin> <!-- generated by postinst script -->' > /tmp/tmp.xml
      for file in ./*.xml;do 
        if [ -e "$file" ] && [ ! -d "$file" ] ;then
          cat $file|grep -v 'skin>'>>/tmp/tmp.xml
        fi
      done
      echo '</skin>' >> /tmp/tmp.xml
      xmllint  --noout /tmp/tmp.xml 1> /dev/null 2>&1
      isValid=$?
      if [ $isValid -eq 0 ];then
        mv -f /tmp/tmp.xml /usr/share/enigma2/BlackHarmony/mySkin/skin_user_BlackHarmony.xml
        [ $etcSkin -eq 1 ] && mv -f /tmp/tmp.xml /etc/enigma2/skin_user_BlackHarmony.xml
        if `grep -q 'osd.language=pl_PL' </etc/enigma2/settings`; then
          echo
          echo "Skórka użytkownika została odświeżona. Zrestartuj GUI aby ją załadować."
        else
          echo
          echo "User skin has beer regenerated successfuly"
        fi
      else
        rm -f /tmp/tmp.xml
        if `grep -q 'osd.language=pl_PL' </etc/enigma2/settings`; then
          echo
          echo "Tryb kopiowania - Nie zapomnij wejść do wtyczki UserSkin i zaktualizować ustawienia"
        else
          echo
          echo "Copy Screens mode - Do not forget to enter UserSkin plugin and do actualization of settings"
        fi
      fi
    fi
    cd ~
  fi
  if `grep -q 'config.plugins.UserSkin.SafeMode=true' </etc/enigma2/settings`; then
    touch /etc/enigma2/skinModified
  fi
fi
sleep 5
exit 0